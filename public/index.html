<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SlugBrawl</title>
<style>
html,body{margin:0;overflow:hidden;background:#0b0f1a;color:#fff;font-family:Arial;touch-action:none}
canvas{display:block}
#menu{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.7);z-index:10}
#menu .box{background:#111827;padding:20px;border-radius:16px;width:90%;max-width:360px}
input,select,button{width:100%;margin-top:10px;padding:12px;border-radius:12px;border:none;font-weight:bold}
button{background:#facc15;color:#000}
.joy{position:fixed;bottom:20px;left:20px;width:140px;height:140px;border-radius:50%;background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.25)}
.knob{width:60px;height:60px;background:#fff;border-radius:50%;position:absolute;left:50%;top:50%;margin:-30px}
#fire{position:fixed;right:40px;bottom:60px;width:90px;height:50px;border-radius:14px;background:#ffb703;color:#000;font-weight:bold;display:flex;align-items:center;justify-content:center}
#end{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:20;align-items:center;justify-content:center;flex-direction:column;font-size:32px}
#hud{position:fixed;top:10px;left:10px;background:rgba(0,0,0,.4);padding:8px 12px;border-radius:10px}
</style>
</head>
<body>

<div id="menu">
  <div class="box">
    <h2>SlugBrawl</h2>
    <input id="name" placeholder="Seu nome">
    <input id="room" placeholder="Sala (ex: sala1)">
    <select id="cls">
      <option value="soldier">Soldado</option>
      <option value="tank">Tank</option>
    </select>
    <button onclick="join()">ENTRAR</button>
  </div>
</div>

<div id="hud">Modo: Solo</div>
<div id="end"><div id="endText"></div><button onclick="restart()">REINICIAR</button></div>

<canvas id="c"></canvas>
<div class="joy" id="joy"><div class="knob"></div></div>
<div id="fire">ATIRAR</div>

<script>
const c=document.getElementById("c"),ctx=c.getContext("2d");
function rs(){c.width=innerWidth;c.height=innerHeight} addEventListener("resize",rs); rs();

const AC=new (window.AudioContext||webkitAudioContext)();
const sfx=f=>{const o=AC.createOscillator(),g=AC.createGain();o.frequency.value=f;o.connect(g);g.connect(AC.destination);o.start();g.gain.exponentialRampToValueAtTime(.001,AC.currentTime+.1);o.stop(AC.currentTime+.1)}

const WS=(location.protocol==="https:"?"wss://":"ws://")+location.host;
let ws,myId=null,snap=null,move={x:0,y:0},aim={x:1,y:0},fire=false;

function join(){
  AC.resume();
  ws=new WebSocket(WS);
  ws.onopen=()=>ws.send(JSON.stringify({t:"join",name:name.value||"Player",room:room.value||"solo",cls:cls.value}));
  ws.onmessage=e=>{
    const m=JSON.parse(e.data);
    if(m.t==="you"){myId=m.id;menu.style.display="none";}
    if(m.t==="snapshot"){
      snap=m;
      hud.textContent="Modo: "+(Object.keys(snap.players).length>1?"Online":"Solo");
      if(snap.result){
        end.style.display="flex";
        endText.textContent = snap.result.win ? (snap.result.win===myId?"VITÃ“RIA!":"DERROTA!") : "DERROTA!";
      }
    }
  };
}
function restart(){ ws.send(JSON.stringify({t:"reset"})); end.style.display="none"; }

(()=>{
  const joy=document.getElementById("joy"),kn=joy.firstChild; let cx,cy;
  joy.onpointerdown=e=>{const r=joy.getBoundingClientRect();cx=r.left+r.width/2;cy=r.top+r.height/2;joy.setPointerCapture(e.pointerId);}
  joy.onpointermove=e=>{
    const dx=e.clientX-cx,dy=e.clientY-cy,d=Math.hypot(dx,dy),m=Math.min(d,45);
    const nx=dx/d*m||0,ny=dy/d*m||0; kn.style.transform=`translate(${nx}px,${ny}px)`;
    move.x=nx/45; move.y=ny/45;
    if(Math.abs(move.x)>0.1||Math.abs(move.y)>0.1){ const l=Math.hypot(move.x,move.y); aim.x=move.x/l; aim.y=move.y/l; }
  };
  joy.onpointerup=()=>{kn.style.transform=""; move.x=move.y=0;}
})();
fireBtn = document.getElementById("fire");
fireBtn.onpointerdown=()=>{fire=true;AC.resume()}; fireBtn.onpointerup=()=>fire=false;

let last=0;
function loop(t){
  if(!snap||!snap.players||!snap.players[myId]){ requestAnimationFrame(loop); return; }
  if(ws&&t-last>50){
    ws.send(JSON.stringify({t:"input",ix:move.x,iy:move.y,aimX:aim.x,aimY:aim.y}));
    if(fire){ ws.send(JSON.stringify({t:"shoot",aimX:aim.x,aimY:aim.y})); sfx(650); }
    last=t;
  }
  draw(); requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

function draw(){
  const me=snap.players[myId];
  const camX=me.x-c.width/2, camY=me.y-c.height/2;
  ctx.clearRect(0,0,c.width,c.height);
  ctx.save(); ctx.translate(-camX,-camY);

  // mapa
  ctx.fillStyle="#0f1a3a";
  ctx.fillRect(0,0,snap.map.w,snap.map.h);

  // balas
  snap.bullets.forEach(b=>{
    ctx.fillStyle=b.from==="e"?"#ff4d6d":"#ffd60a";
    ctx.fillRect(b.x-3,b.y-3,6,6);
  });

  // inimigos
  snap.enemies.forEach(e=>{
    ctx.fillStyle="orange";
    ctx.beginPath();ctx.arc(e.x,e.y,16,0,Math.PI*2);ctx.fill();
    ctx.fillStyle="red";
    ctx.fillRect(e.x-20,e.y-28,40*(e.hp/70),5);
  });

  // players (cor por classe)
  for(const [id,p] of Object.entries(snap.players)){
    let color = (p.cls==="tank") ? "#ef4444" : "#3b82f6";
    ctx.fillStyle=color;
    ctx.beginPath();ctx.arc(p.x,p.y,18,0,Math.PI*2);ctx.fill();

    if(id===myId){
      ctx.strokeStyle="#ffffff"; ctx.lineWidth=4; ctx.stroke();
    }
    ctx.fillStyle="green";
    ctx.fillRect(p.x-20,p.y-30,40*(p.hp/p.max),5);
  }

  ctx.restore();
}
</script>
</body>
</html>
