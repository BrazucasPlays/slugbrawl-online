<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SlugBrawl</title>
<style>
html,body{margin:0;overflow:hidden;background:#0b0f1a;color:#fff;font-family:Arial;touch-action:none}
canvas{display:block}

#menu{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.72);z-index:10}
#menu .box{background:#111827;padding:18px;border-radius:16px;width:92%;max-width:360px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
input,select,button{width:100%;margin-top:10px;padding:12px;border-radius:12px;border:none;font-weight:bold}
button{background:#facc15;color:#000}

#hud{position:fixed;top:10px;left:10px;background:rgba(0,0,0,.45);padding:8px 10px;border-radius:10px;font-weight:bold;z-index:5;max-width:90vw}

#end{display:none;position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:30;align-items:center;justify-content:center;flex-direction:column;text-align:center;padding:18px}
#end h2{margin:0 0 6px 0}
#end .card{background:#111827;border-radius:14px;padding:12px 14px;width:92%;max-width:420px}
#end button{margin-top:12px}

.joy{position:fixed;bottom:18px;width:140px;height:140px;border-radius:50%;background:rgba(255,255,255,.14);border:2px solid rgba(255,255,255,.22);z-index:20}
#joyMove{left:18px}
.knob{width:60px;height:60px;background:#fff;border-radius:50%;position:absolute;left:50%;top:50%;margin:-30px;opacity:.9}
#fireBtn{position:fixed;right:24px;bottom:64px;width:98px;height:56px;border-radius:16px;background:#ffb703;color:#000;font-weight:900;display:flex;align-items:center;justify-content:center;z-index:20;user-select:none}
.small{opacity:.9;font-size:12px;font-weight:700}
</style>
</head>
<body>

<div id="menu">
  <div class="box">
    <h2 style="margin:0 0 8px 0">SlugBrawl</h2>
    <input id="name" placeholder="Seu nome">
    <input id="room" placeholder="Sala (ex: sala1)">
    <select id="cls">
      <option value="soldier">Soldado (rápido)</option>
      <option value="tank">Tank (vida alta)</option>
    </select>
    <div class="small">Regra: a porta só abre após <b>5 kills</b>. A zona fecha, corra!</div>
    <button onclick="join()">ENTRAR</button>
  </div>
</div>

<div id="hud">Conectando…</div>

<div id="end">
  <div class="card">
    <h2 id="endTitle">Fim</h2>
    <div id="endBody"></div>
    <button onclick="restart()">REINICIAR</button>
  </div>
</div>

<canvas id="c"></canvas>
<div id="joyMove" class="joy"><div class="knob"></div></div>
<div id="fireBtn">ATIRAR</div>

<script>
/* =========================
   CANVAS
========================= */
const c = document.getElementById("c");
const ctx = c.getContext("2d");
function resize(){ c.width = innerWidth; c.height = innerHeight; }
addEventListener("resize", resize); resize();

/* =========================
   AUDIO (simples e leve)
========================= */
const AC = new (window.AudioContext||webkitAudioContext)();
function beep(freq, dur=0.08){
  try{
    const o=AC.createOscillator(), g=AC.createGain();
    o.frequency.value=freq;
    o.connect(g); g.connect(AC.destination);
    o.start();
    g.gain.setValueAtTime(0.15, AC.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, AC.currentTime + dur);
    o.stop(AC.currentTime + dur);
  }catch{}
}

/* =========================
   SPRITES (EMBUTIDOS)
   Cartoon Low Poly: gera sprite sheets em canvas
========================= */
function makeSheet(colorA, colorB){
  const W=64,H=64,FR=5;
  const sheet = document.createElement("canvas");
  sheet.width = W*FR; sheet.height = H;
  const g = sheet.getContext("2d");

  function poly(points, fill){
    g.fillStyle = fill;
    g.beginPath();
    g.moveTo(points[0][0], points[0][1]);
    for(let i=1;i<points.length;i++) g.lineTo(points[i][0], points[i][1]);
    g.closePath(); g.fill();
  }

  function frame(i){
    const x0=i*W;
    g.save();
    g.translate(x0,0);
    g.clearRect(0,0,W,H);

    // sombra
    g.fillStyle="rgba(0,0,0,.25)";
    g.beginPath(); g.ellipse(32,54,18,7,0,0,Math.PI*2); g.fill();

    // corpo low-poly (triangulado)
    poly([[20,42],[32,22],[44,42],[32,48]], colorA);        // torso
    poly([[26,50],[32,42],[38,50],[32,58]], colorB);        // perna
    poly([[18,40],[24,30],[28,40]], colorB);                // braço esq
    poly([[46,40],[40,30],[36,40]], colorB);                // braço dir

    // cabeça cartoon
    g.fillStyle = "#f7d7b5";
    g.beginPath(); g.arc(32,18,12,0,Math.PI*2); g.fill();
    g.strokeStyle="rgba(0,0,0,.25)"; g.lineWidth=2;
    g.beginPath(); g.arc(32,18,12,0,Math.PI*2); g.stroke();

    // olhos
    g.fillStyle="#111";
    g.fillRect(27,16,3,3);
    g.fillRect(34,16,3,3);

    // arma (varia por frame)
    g.fillStyle="#2d3748";
    const shoot = (i===3);
    const dead = (i===4);

    if(dead){
      // tombado
      g.globalAlpha=0.9;
      g.translate(32,34);
      g.rotate(-0.9);
      g.translate(-32,-34);
    } else {
      // animação walk: balança pernas
      if(i===1){ g.translate(0,1); }
      if(i===2){ g.translate(0,-1); }
      if(shoot){ g.translate(0,-1); }
    }

    g.fillRect(36,30,18,6);
    g.fillStyle="#555";
    g.fillRect(50,28,8,10);

    // flash de tiro
    if(shoot){
      g.fillStyle="#ffd166";
      poly([[56,33],[62,30],[61,36]], "#ffd166");
    }

    g.restore();
  }

  for(let i=0;i<5;i++) frame(i);
  return sheet;
}

function makeEnemySheet(){
  const W=64,H=64,FR=2;
  const sheet=document.createElement("canvas");
  sheet.width=W*FR; sheet.height=H;
  const g=sheet.getContext("2d");

  function f(i){
    const x0=i*W;
    g.save(); g.translate(x0,0);
    g.clearRect(0,0,W,H);

    // sombra
    g.fillStyle="rgba(0,0,0,.25)";
    g.beginPath(); g.ellipse(32,54,18,7,0,0,Math.PI*2); g.fill();

    // corpo low poly
    g.fillStyle="#f59e0b";
    g.beginPath(); g.moveTo(20,44); g.lineTo(32,22); g.lineTo(46,44); g.closePath(); g.fill();
    g.fillStyle="#fb7185";
    g.beginPath(); g.moveTo(26,48); g.lineTo(32,38); g.lineTo(38,48); g.closePath(); g.fill();

    // cabeça
    g.fillStyle="#fde68a";
    g.beginPath(); g.arc(32,18,12,0,Math.PI*2); g.fill();
    g.strokeStyle="rgba(0,0,0,.25)"; g.lineWidth=2;
    g.beginPath(); g.arc(32,18,12,0,Math.PI*2); g.stroke();

    // olhos “mal”
    g.fillStyle="#111";
    g.fillRect(26,16,4,3);
    g.fillRect(34,16,4,3);

    // walk wobble
    if(i===1){ g.translate(0,1); }

    g.restore();
  }
  f(0); f(1);
  return sheet;
}

function makeHeart(){
  const cn=document.createElement("canvas");
  cn.width=32; cn.height=32;
  const g=cn.getContext("2d");
  g.fillStyle="#22c55e";
  g.beginPath();
  g.moveTo(16,28);
  g.bezierCurveTo(2,18,6,6,16,12);
  g.bezierCurveTo(26,6,30,18,16,28);
  g.fill();
  g.strokeStyle="rgba(0,0,0,.25)"; g.lineWidth=2;
  g.stroke();
  return cn;
}

function makeDoor(open){
  const cn=document.createElement("canvas");
  cn.width=64; cn.height=64;
  const g=cn.getContext("2d");
  // base
  g.fillStyle = open ? "#22c55e" : "#ef4444";
  g.beginPath(); g.roundRect(14,10,36,46,10); g.fill();
  // inner
  g.fillStyle="rgba(255,255,255,.18)";
  g.beginPath(); g.roundRect(18,14,28,38,8); g.fill();
  // knob
  g.fillStyle="#111";
  g.beginPath(); g.arc(44,34,3,0,Math.PI*2); g.fill();
  // outline
  g.strokeStyle="rgba(0,0,0,.35)"; g.lineWidth=3;
  g.beginPath(); g.roundRect(14,10,36,46,10); g.stroke();
  return cn;
}

const SPR = {
  soldier: makeSheet("#3b82f6", "#1d4ed8"),
  tank: makeSheet("#ef4444", "#b91c1c"),
  enemy: makeEnemySheet(),
  heart: makeHeart(),
  doorOpen: makeDoor(true),
  doorClosed: makeDoor(false)
};

function drawSheet(sheet, frame, x, y, size, flip=false){
  const fw=64, fh=64;
  ctx.save();
  ctx.translate(x,y);
  if(flip) ctx.scale(-1,1);
  ctx.drawImage(sheet, frame*fw, 0, fw, fh, -size/2, -size/2, size, size);
  ctx.restore();
}

/* =========================
   NET
========================= */
const WS_URL = (location.protocol==="https:"?"wss://":"ws://")+location.host;
let ws, myId=null, snap=null;

function join(){
  AC.resume();
  ws = new WebSocket(WS_URL);

  ws.onopen = () => {
    ws.send(JSON.stringify({
      t:"join",
      name: document.getElementById("name").value || "Player",
      room: document.getElementById("room").value || "sala1",
      cls: document.getElementById("cls").value
    }));
  };

  ws.onmessage = (e) => {
    const m = JSON.parse(e.data);
    if(m.t==="you"){
      myId = m.id;
      document.getElementById("menu").style.display = "none";
      document.getElementById("end").style.display = "none";
    }
    if(m.t==="snapshot"){
      snap = m;
      renderHUD();
      if(snap.result) showEnd();
    }
  };

  ws.onclose = () => {
    document.getElementById("hud").textContent = "Desconectado. Recarregue a página.";
  };
}

/* =========================
   CONTROLS (joystick move + fire)
========================= */
let move={x:0,y:0};
let aim={x:1,y:0};
let firing=false;
let lastShotAt=0;

(() => {
  const joy = document.getElementById("joyMove");
  const knob = joy.firstChild;
  let cx=0, cy=0, down=false;

  joy.onpointerdown = (e) => {
    down=true;
    const r=joy.getBoundingClientRect();
    cx=r.left+r.width/2; cy=r.top+r.height/2;
    joy.setPointerCapture(e.pointerId);
  };
  joy.onpointermove = (e) => {
    if(!down) return;
    const dx=e.clientX-cx, dy=e.clientY-cy;
    const dist=Math.hypot(dx,dy);
    const m=Math.min(dist,45);
    const nx=(dx/dist)*m || 0;
    const ny=(dy/dist)*m || 0;
    knob.style.transform = `translate(${nx}px,${ny}px)`;
    move.x = nx/45; move.y = ny/45;

    // aim direction follows last movement
    if(Math.abs(move.x)>0.1 || Math.abs(move.y)>0.1){
      const l=Math.hypot(move.x,move.y) || 1;
      aim.x = move.x/l; aim.y = move.y/l;
    }
  };
  joy.onpointerup = () => {
    down=false;
    knob.style.transform = "";
    move.x=0; move.y=0;
  };
})();

const fireBtn = document.getElementById("fireBtn");
fireBtn.onpointerdown = () => { firing=true; AC.resume(); };
fireBtn.onpointerup = () => { firing=false; };

let lastSend=0;
function netTick(t){
  if(!ws || ws.readyState!==1 || !snap || !snap.players || !snap.players[myId]) return;

  // send input 20hz
  if(t - lastSend > 50){
    ws.send(JSON.stringify({t:"input", ix:move.x, iy:move.y, aimX:aim.x, aimY:aim.y}));
    lastSend=t;
  }

  if(firing){
    // shoot 8/s (client request; server enforces cooldown too)
    if(t - lastShotAt > 125){
      ws.send(JSON.stringify({t:"shoot", aimX:aim.x, aimY:aim.y}));
      lastShotAt = t;
      beep(650);
    }
  }
}

/* =========================
   UI (HUD + END)
========================= */
function renderHUD(){
  const r = snap;
  const me = r.players[myId];
  const count = Object.keys(r.players).length;
  const door = r.map.door;
  const doorText = door.open ? "PORTA: ABERTA" : "PORTA: FECHADA (mate 5)";
  const zone = Math.max(0, Math.floor((r.map.close/560)*100));
  document.getElementById("hud").textContent =
    `Modo: ${count>1?"Online":"Solo"} | HP: ${Math.floor(me.hp)}/${me.max} | Kills: ${me.kills} | ${doorText} | Zona: ${zone}%`;
}

function showEnd(){
  const end = document.getElementById("end");
  const endTitle = document.getElementById("endTitle");
  const endBody = document.getElementById("endBody");
  const me = snap.players[myId];

  // placar
  const players = Object.values(snap.players).slice().sort((a,b)=>b.kills-a.kills);
  let scoreboard = "<div style='margin-top:10px;text-align:left'>";
  scoreboard += "<b>Placar (kills)</b><br>";
  for(const p of players){
    const you = (p.id===myId) ? " (você)" : "";
    scoreboard += `• ${p.name}${you}: <b>${p.kills}</b><br>`;
  }
  scoreboard += "</div>";

  if(snap.result.win){
    endTitle.textContent = (snap.result.win===myId) ? "VITÓRIA!" : "DERROTA!";
  } else {
    endTitle.textContent = "DERROTA!";
  }

  endBody.innerHTML =
    `Seu resultado: <b>${me.kills}</b> kills<br>` +
    `<span class="small">Dica: a porta só abre após 5 kills, e a zona fecha!</span>` +
    scoreboard;

  end.style.display = "flex";
}

function restart(){
  if(ws && ws.readyState===1){
    ws.send(JSON.stringify({t:"reset"}));
    document.getElementById("end").style.display="none";
  }else{
    location.reload();
  }
}

/* =========================
   DRAW
========================= */
function draw(){
  if(!snap || !snap.players || !snap.players[myId]) return;

  const me = snap.players[myId];
  const camX = me.x - c.width/2;
  const camY = me.y - c.height/2;

  ctx.clearRect(0,0,c.width,c.height);
  ctx.save();
  ctx.translate(-camX, -camY);

  // map bg
  ctx.fillStyle = "#0f1a3a";
  ctx.fillRect(0,0,snap.map.w,snap.map.h);

  // zone closing (visual)
  ctx.strokeStyle = "rgba(255, 80, 80, .45)";
  ctx.lineWidth = 8;
  ctx.strokeRect(
    snap.map.close, snap.map.close,
    snap.map.w - snap.map.close*2,
    snap.map.h - snap.map.close*2
  );

  // door
  const d = snap.map.door;
  const doorImg = d.open ? SPR.doorOpen : SPR.doorClosed;
  ctx.drawImage(doorImg, d.x-32, d.y-32, 64, 64);

  // lifes
  for(const l of snap.lifes){
    ctx.drawImage(SPR.heart, l.x-16, l.y-16, 32, 32);
  }

  // bullets
  for(const b of snap.bullets){
    ctx.fillStyle = (b.from==="e") ? "#ff4d6d" : "#ffd60a";
    ctx.fillRect(b.x-3,b.y-3,6,6);
  }

  // enemies (2-frame anim)
  for(const e of snap.enemies){
    const f = Math.floor(performance.now()/200)%2;
    drawSheet(SPR.enemy, f, e.x, e.y, 54, e.vx < 0);
    // hp bar
    ctx.fillStyle="rgba(0,0,0,.35)";
    ctx.fillRect(e.x-22,e.y-40,44,6);
    ctx.fillStyle="#ef4444";
    ctx.fillRect(e.x-22,e.y-40,44*(e.hp/70),6);
  }

  // players (5 frames)
  for(const [id,p] of Object.entries(snap.players)){
    const walking = Math.hypot(p.ix||0, p.iy||0) > 0.1;
    const dead = !p.alive;
    const recentShoot = (id===myId && firing) || (performance.now()-lastShotAt<120 && id===myId);

    let frame = 0;
    if(dead) frame = 4;
    else if(recentShoot) frame = 3;
    else if(walking) frame = (Math.floor(performance.now()/140)%2) + 1;
    else frame = 0;

    const sheet = (p.cls==="tank") ? SPR.tank : SPR.soldier;
    const flip = (p.aimX||1) < 0;

    drawSheet(sheet, frame, p.x, p.y, 58, flip);

    // local highlight
    if(id===myId){
      ctx.strokeStyle="#ffffff";
      ctx.lineWidth=3;
      ctx.beginPath();
      ctx.arc(p.x,p.y,34,0,Math.PI*2);
      ctx.stroke();
    }

    // hp bar
    ctx.fillStyle="rgba(0,0,0,.35)";
    ctx.fillRect(p.x-24,p.y-46,48,6);
    ctx.fillStyle="#22c55e";
    ctx.fillRect(p.x-24,p.y-46,48*(p.hp/p.max),6);
  }

  ctx.restore();
}

/* =========================
   MAIN LOOP
========================= */
function loop(t){
  netTick(t);
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
