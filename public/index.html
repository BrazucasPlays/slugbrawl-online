
<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<style>
body{
    margin:0;
    background:#000;
    color:#fff;
    font-family:Arial, sans-serif;
    -webkit-user-select: none; 
    user-select: none;
    touch-action: none; 
    overflow: hidden;
}
canvas{display:block}
#menu, #endMenu{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.8);z-index: 100;}
#box, #endBox{background:#111;padding:20px;border-radius:12px;width:280px; text-align: center; border: 2px solid #333;}
input,button{width:100%;margin-top:10px;padding:12px;border-radius:8px;border:none;box-sizing: border-box;}
button{background:#ffc;color:#000;font-weight:bold; cursor: pointer;}
#hud{position:fixed;top:10px;left:10px;font-weight:bold; color: #fff; text-shadow: 1px 1px 2px #000; pointer-events: none;}
#soundToggle{position:fixed;top:10px;right:10px;padding:10px;background:#333;color:#fff;border-radius:8px;cursor:pointer; z-index: 110;}

#playerSelect{margin: 15px 0; display: flex; justify-content: space-around;}
.colorOption{width: 30px; height: 30px; border-radius: 50%; border: 3px solid transparent; cursor: pointer;}
.colorOption.selected{border-color: #ffc;}

#joy{position:fixed;left:40px;bottom:40px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2);}
#knob{position:absolute;left:50%;top:50%;width:50px;height:50px;margin:-25px;border-radius:50%;background:#fff; box-shadow: 0 0 10px rgba(0,0,0,0.5);}
#fire{position:fixed;right:40px;bottom:60px;width:80px;height:80px;background:#ffc;color:#000;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold; font-size: 12px; box-shadow: 0 4px 0 #bba;}

#endTitle{font-size: 1.8em; margin-bottom: 10px;}
</style>
</head>
<body>

<div id="menu">
  <div id="box">
    <h3>SLUG BRAWL</h3>
    <input id="name" placeholder="Teu Nome" maxlength="12">
    <div id="playerSelect">
        <div class="colorOption selected" style="background:#22c55e" data-color="#22c55e" onclick="selectColor(this)"></div>
        <div class="colorOption" style="background:#3b82f6" data-color="#3b82f6" onclick="selectColor(this)"></div>
        <div class="colorOption" style="background:#a855f7" data-color="#a855f7" onclick="selectColor(this)"></div>
        <div class="colorOption" style="background:#f97316" data-color="#f97316" onclick="selectColor(this)"></div>
    </div>
    <input id="room" placeholder="Sala (Opcional)">
    <button onclick="join()">INICIAR JOGO</button>
  </div>
</div>

<div id="endMenu" style="display:none">
    <div id="endBox">
        <h3 id="endTitle">FIM</h3>
        <div id="endStats"></div>
        <button onclick="restartGame()">REINICIAR TUDO</button>
    </div>
</div>

<div id="hud"></div>
<div id="soundToggle" onclick="Audio.toggleMute()">üîä Som ON</div>
<canvas id="c"></canvas>
<div id="joy"><div id="knob"></div></div>
<div id="fire">ATIRAR</div>

<script>
const c=document.getElementById("c"), ctx=c.getContext("2d");
const MAP_W = 1800, MAP_H = 1000;
let ws, myId, state, roomKey="solo";
let lastHp = 100, isGameOver = true, playerColor = "#22c55e";
let isFiring = false, fireCooldown = 0;
const FIRE_RATE = 5;

function resize(){ c.width=innerWidth; c.height=innerHeight; }
window.onresize = resize; resize();

function selectColor(el){
    document.querySelectorAll('.colorOption').forEach(e=>e.classList.remove('selected'));
    el.classList.add('selected');
    playerColor = el.dataset.color;
}

// --- TIRO CONT√çNUO ---
function continuousShoot() {
    if (!isFiring || isGameOver) return;
    if (fireCooldown <= 0) {
        if (ws && ws.readyState === 1) {
            Audio.playSound('shoot', 0.4);
            ws.send(JSON.stringify({t:"shoot", ax:aim.x, ay:aim.y}));
        }
        fireCooldown = FIRE_RATE;
    }
    fireCooldown--;
    requestAnimationFrame(continuousShoot);
}

// --- CONEX√ÉO E REIN√çCIO ---
function join(){
    const n = document.getElementById("name").value.trim();
    if(!n) return alert("Digita um nome!");
    
    // Reset de vari√°veis locais
    state = null; myId = null; lastHp = 100; isGameOver = false;
    
    if(!ws || ws.readyState !== 1){
        ws = new WebSocket((location.protocol==="https:"?"wss://":"ws://")+location.hostname);
        ws.onmessage = handleMsg;
    }

    ws.onopen = () => {
        roomKey = document.getElementById("room").value || "solo";
        ws.send(JSON.stringify({t:"join", name:n, room:roomKey, color:playerColor}));
        document.getElementById("menu").style.display="none";
        document.getElementById("endMenu").style.display="none";
    };
    
    if(ws.readyState === 1) ws.onopen();
}

function restartGame(){
    if(ws && ws.readyState === 1) ws.send(JSON.stringify({t:"reset"}));
    if(ws) ws.close();
    isGameOver = true;
    isFiring = false;
    ctx.clearRect(0,0,c.width,c.height); // Limpa o ecr√£ imediatamente
    setTimeout(join, 600); // Tempo para o servidor limpar a sala
}

function handleMsg(e){
    const m = JSON.parse(e.data);
    if(m.t==="you") myId = m.id;
    if(m.t==="state"){
        state = m.rooms[roomKey];
        if(!state) return;
        const me = state.players[myId];
        if(me){
            if(me.hp < lastHp && me.hp > 0) Audio.playSound('damage', 0.6);
            lastHp = me.hp;
            if(me.status && !isGameOver) showEnd(me.status, me.kills);
        }
    }
}

function showEnd(s, k){
    isGameOver = true; isFiring = false;
    const t = document.getElementById("endTitle");
    t.textContent = s === 'victory' ? "VIT√ìRIA!" : "ELIMINADO!";
    t.style.color = s === 'victory' ? "#22c55e" : "#f44";
    document.getElementById("endStats").innerHTML = `<p>Inimigos derrotados: ${k}</p>`;
    document.getElementById("endMenu").style.display = "flex";
    Audio.playSound(s === 'victory' ? 'victory' : 'death', 0.8);
}

// --- CONTROLOS ---
let aim={x:1,y:0}, move={x:0,y:0}, drag=false;
const joy=document.getElementById("joy"), knob=document.getElementById("knob");

joy.onpointerdown=e=>{ drag=true; Audio.context.resume(); };
window.onpointermove=e=>{
    if(!drag || isGameOver) return;
    const r=joy.getBoundingClientRect(), cx=r.left+60, cy=r.top+60;
    const dx=e.clientX-cx, dy=e.clientY-cy, dist=Math.hypot(dx,dy);
    const m=Math.min(dist, 50);
    const nx=(dx/dist||0)*m, ny=(dy/dist||0)*m;
    knob.style.transform=`translate(${nx}px,${ny}px)`;
    move={x:nx/50, y:ny/50};
    if(dist>5) aim={x:dx/dist, y:dy/dist};
    ws.send(JSON.stringify({t:"move", x:move.x, y:move.y}));
};
window.onpointerup=()=>{
    drag=false; knob.style.transform="";
    if(ws && ws.readyState===1) ws.send(JSON.stringify({t:"move",x:0,y:0}));
};

const fBtn = document.getElementById("fire");
fBtn.onpointerdown=e=>{ 
    if(isGameOver) return;
    isFiring=true; fireCooldown=0; continuousShoot(); 
    e.preventDefault(); 
};
window.onpointerup=()=>{ isFiring=false; };

// --- √ÅUDIO SINT√âTICO ---
const Audio = {
    context: new (window.AudioContext || window.webkitAudioContext)(),
    isMuted: false,
    async playSound(type, vol=1){
        if(this.isMuted) return;
        const ctx=this.context;
        const osc=ctx.createOscillator(), gain=ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        gain.gain.setValueAtTime(vol, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
        
        if(type==='shoot'){ osc.type='square'; osc.frequency.setValueAtTime(600, ctx.currentTime); }
        if(type==='damage'){ osc.type='sawtooth'; osc.frequency.setValueAtTime(120, ctx.currentTime); }
        if(type==='death'){ osc.type='sine'; osc.frequency.setValueAtTime(60, ctx.currentTime); gain.gain.setTargetAtTime(0, ctx.currentTime, 0.5); }
        if(type==='victory'){ osc.type='sine'; osc.frequency.setValueAtTime(800, ctx.currentTime); osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime+0.2); }
        
        osc.start(); osc.stop(ctx.currentTime + 0.3);
    },
    toggleMute(){ 
        this.isMuted = !this.isMuted; 
        document.getElementById('soundToggle').textContent = this.isMuted ? 'üîá Som OFF' : 'üîä Som ON';
    }
};

// --- RENDER ---
function draw(){
    ctx.clearRect(0,0,c.width,c.height);
    if(!state || !myId || !state.players[myId]) return requestAnimationFrame(draw);
    
    const me = state.players[myId];
    ctx.save();
    ctx.translate(c.width/2 - me.x, c.height/2 - me.y);
    
    // Fundo
    ctx.fillStyle='#2d3d2a'; ctx.fillRect(0,0,MAP_W,MAP_H);
    
    // Zona
    ctx.fillStyle='rgba(255,0,0,0.2)';
    ctx.fillRect(0,0,MAP_W,state.zone); ctx.fillRect(0,MAP_H-state.zone,MAP_W,state.zone);
    ctx.fillRect(0,state.zone,state.zone,MAP_H-state.zone*2); ctx.fillRect(MAP_W-state.zone,state.zone,state.zone,MAP_H-state.zone*2);

    // Porta
    ctx.fillStyle=state.door.open?'#44f':'#666';
    ctx.fillRect(state.door.x-25, state.door.y-25, 50, 50);
    
    // Items de Vida
    state.lifes.forEach(l=>{
        ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(l.x,l.y,10,0,7); ctx.fill();
        ctx.fillStyle='#f00'; ctx.fillRect(l.x-2,l.y-8,4,16); ctx.fillRect(l.x-8,l.y-2,16,4);
    });

    // Balas
    state.bullets.forEach(b=>{
        ctx.fillStyle=b.from==='e'?'#f44':'#fff';
        ctx.beginPath(); ctx.arc(b.x,b.y,4,0,7); ctx.fill();
    });

    // Inimigos
    state.enemies.forEach(e=>{
        ctx.fillStyle='#f1c40f'; ctx.beginPath(); ctx.arc(e.x,e.y,15,0,7); ctx.fill();
        ctx.fillStyle='#000'; ctx.fillRect(e.x-15,e.y-25,30,4);
        ctx.fillStyle='#f00'; ctx.fillRect(e.x-15,e.y-25,30*(e.hp/60),4);
    });

    // Jogadores
    for(let id in state.players){
        const p = state.players[id];
        if(!p.alive && p.status !== 'victory') continue;
        ctx.fillStyle = p.color;
        ctx.beginPath(); ctx.arc(p.x,p.y,18,0,7); ctx.fill();
        ctx.fillStyle='#fff'; ctx.font='12px Arial'; ctx.textAlign='center';
        ctx.fillText(p.name, p.x, p.y-30);
        ctx.fillStyle='rgba(0,0,0,0.5)'; ctx.fillRect(p.x-20,p.y-25,40,5);
        ctx.fillStyle='#2ecc71'; ctx.fillRect(p.x-20,p.y-25,40*(p.hp/100),5);
    }
    
    ctx.restore();
    
    document.getElementById('hud').innerHTML = `HP: ${Math.floor(me.hp)} | MORTES: ${me.kills}`;
    requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>
