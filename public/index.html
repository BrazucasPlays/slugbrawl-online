<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SlugBrawl</title>
<style>
html,body{margin:0;background:#0b1020;overflow:hidden;color:#fff;font-family:Arial}
canvas{display:block}
#menu{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center}
button,input,select{padding:12px;margin:6px;border-radius:10px;border:none}
</style>
</head>
<body>

<div id="menu">
  <div>
    <h2>SlugBrawl</h2>
    <input id="room" placeholder="Sala">
    <select id="cls">
      <option value="soldier">Soldado</option>
      <option value="tank">Tank</option>
    </select>
    <button onclick="start()">Jogar</button>
  </div>
</div>

<canvas id="c"></canvas>

<script>
const c = document.getElementById("c"), ctx = c.getContext("2d");
function resize(){c.width=innerWidth;c.height=innerHeight}
addEventListener("resize",resize);resize();

const WS = new WebSocket((location.protocol==="https:"?"wss://":"ws://")+location.host);
let id=null,state=null,ix=0,iy=0;

WS.onmessage = e => {
  const m = JSON.parse(e.data);
  if(m.t==="you") id=m.id;
  if(m.t==="state") state=m.room;
};

function start(){
  WS.send(JSON.stringify({t:"join",room:room.value||"solo",cls:cls.value}));
  menu.style.display="none";
}

addEventListener("keydown",e=>{
  if(e.key==="w")iy=-1;
  if(e.key==="s")iy=1;
  if(e.key==="a")ix=-1;
  if(e.key==="d")ix=1;
});
addEventListener("keyup",()=>{ix=iy=0});

setInterval(()=>{
  if(id) WS.send(JSON.stringify({t:"input",ix,iy}));
},50);

function drawChar(p){
  ctx.save();
  ctx.translate(p.x,p.y);
  ctx.fillStyle=p.cls==="tank"?"#ef4444":"#3b82f6";
  ctx.beginPath();
  ctx.arc(0,0,20,0,Math.PI*2);
  ctx.fill();
  ctx.fillStyle="#000";
  ctx.fillRect(-8,-5,16,6);
  ctx.restore();
}

function loop(){
  if(!state){requestAnimationFrame(loop);return;}
  ctx.clearRect(0,0,c.width,c.height);
  const me=state.players[id];
  ctx.save();
  ctx.translate(c.width/2-me.x,c.height/2-me.y);

  Object.values(state.players).forEach(drawChar);

  ctx.restore();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
