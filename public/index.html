<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>SlugBrawl Online</title>
<style>
html,body{margin:0;overflow:hidden;background:#071022;color:#fff;font-family:Arial;touch-action:none}
canvas{display:block}
#menu{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.72);z-index:10}
#menu .box{width:92%;max-width:360px;background:#111827;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.4)}
h2{margin:0 0 8px 0}
input,select,button{width:100%;margin-top:10px;padding:12px;border-radius:12px;border:none;font-weight:900}
button{background:#facc15;color:#000}
.small{font-size:12px;opacity:.9;font-weight:800;margin-top:10px}
#hud{position:fixed;top:10px;left:10px;z-index:5;background:rgba(0,0,0,.45);padding:8px 10px;border-radius:10px;font-weight:900;max-width:95vw}
#end{position:fixed;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;background:rgba(0,0,0,.78);z-index:30}
#end .card{width:92%;max-width:420px;background:#111827;border-radius:16px;padding:14px}
#end h2{margin:0 0 6px 0}

.joy{position:fixed;bottom:18px;width:150px;height:150px;border-radius:50%;background:rgba(255,255,255,.12);border:2px solid rgba(255,255,255,.18);z-index:20}
#joyMove{left:18px}
.knob{width:62px;height:62px;border-radius:50%;background:#fff;position:absolute;left:50%;top:50%;margin:-31px;opacity:.92}
#fireBtn{position:fixed;right:22px;bottom:64px;width:108px;height:60px;border-radius:18px;background:#ffb703;color:#000;font-weight:1000;display:flex;align-items:center;justify-content:center;z-index:20;user-select:none}
</style>
</head>
<body>

<div id="menu">
  <div class="box">
    <h2>SlugBrawl</h2>
    <input id="name" placeholder="Seu nome" maxlength="14"/>
    <input id="room" placeholder="Sala (ex: sala1)" maxlength="24"/>
    <select id="cls">
      <option value="soldier">Soldado (rápido)</option>
      <option value="tank">Tank (vida alta)</option>
    </select>
    <div class="small">
      Porta abre com <b>5 kills</b>. A zona fecha. Vence quem entrar na porta (e tiver mais kills).
    </div>
    <button id="joinBtn">ENTRAR</button>
  </div>
</div>

<div id="hud">Abra o menu e clique ENTRAR</div>

<div id="end">
  <div class="card">
    <h2 id="endTitle">Fim</h2>
    <div id="endBody"></div>
    <button id="restartBtn">REINICIAR</button>
  </div>
</div>

<canvas id="c"></canvas>
<div id="joyMove" class="joy"><div class="knob"></div></div>
<div id="fireBtn">ATIRAR</div>

<script>
/* ===== Canvas ===== */
const c = document.getElementById("c");
const ctx = c.getContext("2d");
function resize(){ c.width = innerWidth; c.height = innerHeight; }
addEventListener("resize", resize); resize();

/* ===== Audio (beeps) ===== */
const AC = new (window.AudioContext||webkitAudioContext)();
function beep(freq, dur=0.06, gain=0.12){
  try{
    const o=AC.createOscillator(), g=AC.createGain();
    o.type="square";
    o.frequency.value=freq;
    o.connect(g); g.connect(AC.destination);
    g.gain.setValueAtTime(gain, AC.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, AC.currentTime+dur);
    o.start();
    o.stop(AC.currentTime+dur);
  }catch{}
}

/* ===== Sprites (procedural low-poly cartoon) ===== */
CanvasRenderingContext2D.prototype.roundRect ||= function(x,y,w,h,r){
  r = Math.min(r, w/2, h/2);
  this.beginPath();
  this.moveTo(x+r,y);
  this.arcTo(x+w,y,x+w,y+h,r);
  this.arcTo(x+w,y+h,x,y+h,r);
  this.arcTo(x,y+h,x,y,r);
  this.arcTo(x,y,x+w,y,r);
  this.closePath();
  return this;
};
function makeSheet(colorA, colorB){
  const W=64,H=64,FR=5;
  const sheet=document.createElement("canvas");
  sheet.width=W*FR; sheet.height=H;
  const g=sheet.getContext("2d");

  const poly=(pts,fill)=>{
    g.fillStyle=fill;
    g.beginPath(); g.moveTo(pts[0][0],pts[0][1]);
    for(let i=1;i<pts.length;i++) g.lineTo(pts[i][0],pts[i][1]);
    g.closePath(); g.fill();
  };

  for(let i=0;i<FR;i++){
    const x0=i*W;
    g.save(); g.translate(x0,0); g.clearRect(0,0,W,H);

    // shadow
    g.fillStyle="rgba(0,0,0,.25)";
    g.beginPath(); g.ellipse(32,54,18,7,0,0,Math.PI*2); g.fill();

    const shoot=i===3, dead=i===4;

    if(dead){
      g.translate(32,34); g.rotate(-0.9); g.translate(-32,-34);
      g.globalAlpha=0.9;
    } else {
      if(i===1) g.translate(0,1);
      if(i===2) g.translate(0,-1);
      if(shoot) g.translate(0,-1);
    }

    // torso
    poly([[20,42],[32,22],[44,42],[32,48]], colorA);
    // legs
    poly([[26,50],[32,42],[38,50],[32,58]], colorB);
    // arms
    poly([[18,40],[24,30],[28,40]], colorB);
    poly([[46,40],[40,30],[36,40]], colorB);

    // head
    g.fillStyle="#f7d7b5";
    g.beginPath(); g.arc(32,18,12,0,Math.PI*2); g.fill();
    g.strokeStyle="rgba(0,0,0,.25)"; g.lineWidth=2;
    g.beginPath(); g.arc(32,18,12,0,Math.PI*2); g.stroke();

    // eyes
    g.fillStyle="#111";
    g.fillRect(27,16,3,3); g.fillRect(34,16,3,3);

    // gun
    g.fillStyle="#2d3748";
    g.fillRect(36,30,18,6);
    g.fillStyle="#555";
    g.fillRect(50,28,8,10);

    // muzzle flash
    if(shoot){
      poly([[56,33],[62,30],[61,36]], "#ffd166");
    }

    g.restore();
  }
  return sheet;
}
function makeEnemySheet(){
  const W=64,H=64,FR=2;
  const sheet=document.createElement("canvas");
  sheet.width=W*FR; sheet.height=H;
  const g=sheet.getContext("2d");

  for(let i=0;i<FR;i++){
    const x0=i*W;
    g.save(); g.translate(x0,0); g.clearRect(0,0,W,H);

    g.fillStyle="rgba(0,0,0,.25)";
    g.beginPath(); g.ellipse(32,54,18,7,0,0,Math.PI*2); g.fill();

    if(i===1) g.translate(0,1);

    g.fillStyle="#f59e0b";
    g.beginPath(); g.moveTo(20,44); g.lineTo(32,22); g.lineTo(46,44); g.closePath(); g.fill();

    g.fillStyle="#fb7185";
    g.beginPath(); g.moveTo(26,48); g.lineTo(32,38); g.lineTo(38,48); g.closePath(); g.fill();

    g.fillStyle="#fde68a";
    g.beginPath(); g.arc(32,18,12,0,Math.PI*2); g.fill();
    g.strokeStyle="rgba(0,0,0,.25)"; g.lineWidth=2;
    g.beginPath(); g.arc(32,18,12,0,Math.PI*2); g.stroke();

    g.fillStyle="#111";
    g.fillRect(26,16,4,3);
    g.fillRect(34,16,4,3);

    g.restore();
  }
  return sheet;
}
function makeHeart(){
  const cn=document.createElement("canvas");
  cn.width=32; cn.height=32;
  const g=cn.getContext("2d");
  g.fillStyle="#22c55e";
  g.beginPath();
  g.moveTo(16,28);
  g.bezierCurveTo(2,18,6,6,16,12);
  g.bezierCurveTo(26,6,30,18,16,28);
  g.fill();
  g.strokeStyle="rgba(0,0,0,.25)"; g.lineWidth=2; g.stroke();
  return cn;
}
function makeDoor(open){
  const cn=document.createElement("canvas");
  cn.width=64; cn.height=64;
  const g=cn.getContext("2d");
  g.fillStyle=open?"#22c55e":"#ef4444";
  g.roundRect(14,10,36,46,10).fill();
  g.fillStyle="rgba(255,255,255,.18)";
  g.roundRect(18,14,28,38,8).fill();
  g.fillStyle="#111";
  g.beginPath(); g.arc(44,34,3,0,Math.PI*2); g.fill();
  g.strokeStyle="rgba(0,0,0,.35)"; g.lineWidth=3;
  g.roundRect(14,10,36,46,10).stroke();
  return cn;
}

const SPR = {
  soldier: makeSheet("#3b82f6","#1d4ed8"),
  tank: makeSheet("#ef4444","#b91c1c"),
  enemy: makeEnemySheet(),
  heart: makeHeart(),
  doorOpen: makeDoor(true),
  doorClosed: makeDoor(false)
};
function drawSheet(sheet, frame, x, y, size, flip=false){
  const fw=64, fh=64;
  ctx.save();
  ctx.translate(x,y);
  if(flip) ctx.scale(-1,1);
  ctx.drawImage(sheet, frame*fw, 0, fw, fh, -size/2, -size/2, size, size);
  ctx.restore();
}

/* ===== Net ===== */
const WS_URL = (location.protocol==="https:" ? "wss://" : "ws://") + location.host;
let ws=null, myId=null, snap=null;

function setHud(t){ document.getElementById("hud").textContent = t; }

function join(){
  AC.resume();
  setHud("Conectando…");

  ws = new WebSocket(WS_URL);
  ws.onopen = () => {
    ws.send(JSON.stringify({
      t:"join",
      name: document.getElementById("name").value || "Player",
      room: document.getElementById("room").value || "sala1",
      cls: document.getElementById("cls").value
    }));
  };
  ws.onmessage = (e) => {
    const m = JSON.parse(e.data);
    if(m.t==="you"){
      myId = m.id;
      document.getElementById("menu").style.display="none";
      document.getElementById("end").style.display="none";
      setHud("Entrou! Aguarde…");
      beep(880,0.07,0.14);
    }
    if(m.t==="snapshot"){
      snap = m;
      renderHUD();
      if(snap.result) showEnd();
    }
  };
  ws.onerror = () => setHud("Erro de conexão. Recarregue.");
  ws.onclose = () => setHud("Desconectado. Recarregue.");
}

/* ===== Controls ===== */
let move={x:0,y:0};
let aim={x:1,y:0};
let firing=false;
let lastSend=0;
let lastShot=0;

function updateAimFromMove(){
  if(Math.abs(move.x)>0.1 || Math.abs(move.y)>0.1){
    const l=Math.hypot(move.x,move.y)||1;
    aim.x=move.x/l; aim.y=move.y/l;
  }
}

// joystick move
(() => {
  const joy = document.getElementById("joyMove");
  const knob = joy.firstChild;
  let cx=0, cy=0, down=false;

  joy.onpointerdown = (e) => {
    down=true;
    const r=joy.getBoundingClientRect();
    cx=r.left+r.width/2; cy=r.top+r.height/2;
    joy.setPointerCapture(e.pointerId);
  };
  joy.onpointermove = (e) => {
    if(!down) return;
    const dx=e.clientX-cx, dy=e.clientY-cy;
    const dist=Math.hypot(dx,dy);
    const m=Math.min(dist,48);
    const nx=(dx/dist)*m || 0;
    const ny=(dy/dist)*m || 0;
    knob.style.transform = `translate(${nx}px,${ny}px)`;
    move.x = nx/48; move.y = ny/48;
    updateAimFromMove();
  };
  joy.onpointerup = () => {
    down=false;
    knob.style.transform = "";
    move.x=0; move.y=0;
  };
})();

// fire button
const fireBtn = document.getElementById("fireBtn");
fireBtn.onpointerdown = ()=>{ firing=true; AC.resume(); };
fireBtn.onpointerup = ()=>{ firing=false; };

// keyboard (desktop)
addEventListener("keydown",(e)=>{
  if(e.key==="w"||e.key==="ArrowUp") move.y=-1;
  if(e.key==="s"||e.key==="ArrowDown") move.y=1;
  if(e.key==="a"||e.key==="ArrowLeft") move.x=-1;
  if(e.key==="d"||e.key==="ArrowRight") move.x=1;
  updateAimFromMove();
});
addEventListener("keyup",(e)=>{
  if(["w","s","ArrowUp","ArrowDown"].includes(e.key)) move.y=0;
  if(["a","d","ArrowLeft","ArrowRight"].includes(e.key)) move.x=0;
});

// send input + shoot
function netTick(t){
  if(!ws || ws.readyState!==1 || !snap || !snap.players || !snap.players[myId]) return;

  if(t-lastSend>50){
    ws.send(JSON.stringify({t:"input", ix:move.x, iy:move.y, aimX:aim.x, aimY:aim.y}));
    lastSend=t;
  }

  if(firing && (t-lastShot>140)){
    ws.send(JSON.stringify({t:"shoot"}));
    lastShot=t;
    beep(650,0.05,0.12);
  }
}

/* ===== UI ===== */
function renderHUD(){
  const me=snap.players[myId];
  const count=Object.keys(snap.players).length;
  const door=snap.map.door.open ? "PORTA: ABERTA" : "PORTA: FECHADA (5 kills)";
  const zone=Math.max(0,Math.floor((snap.map.close/560)*100));
  setHud(`Modo: ${count>1?"Online":"Solo"} | HP: ${Math.floor(me.hp)}/${me.max} | Kills: ${me.kills} | ${door} | Zona: ${zone}%`);
}

function showEnd(){
  const end=document.getElementById("end");
  const title=document.getElementById("endTitle");
  const body=document.getElementById("endBody");

  const me=snap.players[myId];
  const list=Object.values(snap.players).slice().sort((a,b)=>b.kills-a.kills);

  let html=`Seu resultado: <b>${me.kills}</b> kills<br><br><b>Placar</b><br>`;
  for(const p of list){
    html += `• ${p.name}${p.id===myId?" (você)":""}: <b>${p.kills}</b><br>`;
  }

  if(snap.result && snap.result.win){
    title.textContent = (snap.result.win===myId) ? "VITÓRIA!" : "DERROTA!";
    beep(snap.result.win===myId?990:220,0.12,0.14);
  } else {
    title.textContent = "DERROTA!";
    beep(220,0.12,0.14);
  }

  body.innerHTML=html;
  end.style.display="flex";
}

function restart(){
  if(ws && ws.readyState===1){
    ws.send(JSON.stringify({t:"reset"}));
    document.getElementById("end").style.display="none";
    beep(520,0.08,0.14);
  } else location.reload();
}

/* ===== Render ===== */
const endDiv=document.getElementById("end");
const joinBtn=document.getElementById("joinBtn");
const restartBtn=document.getElementById("restartBtn");
joinBtn.addEventListener("click", join);
restartBtn.addEventListener("click", restart);

function draw(){
  if(!snap || !snap.players || !snap.players[myId]) return;

  const me=snap.players[myId];
  const camX = me.x - c.width/2;
  const camY = me.y - c.height/2;

  ctx.clearRect(0,0,c.width,c.height);
  ctx.save(); ctx.translate(-camX,-camY);

  // map
  ctx.fillStyle="#0f1a3a";
  ctx.fillRect(0,0,snap.map.w,snap.map.h);

  // zone border
  ctx.strokeStyle="rgba(255,80,80,.45)";
  ctx.lineWidth=8;
  ctx.strokeRect(
    snap.map.close, snap.map.close,
    snap.map.w - snap.map.close*2,
    snap.map.h - snap.map.close*2
  );

  // door
  const d=snap.map.door;
  ctx.drawImage(d.open?SPR.doorOpen:SPR.doorClosed, d.x-32, d.y-32, 64, 64);

  // lifes
  for(const l of snap.lifes){
    ctx.drawImage(SPR.heart, l.x-16, l.y-16, 32, 32);
  }

  // bullets
  for(const b of snap.bullets){
    ctx.fillStyle = (b.from==="e") ? "#ff4d6d" : "#ffd60a";
    ctx.fillRect(b.x-3,b.y-3,6,6);
  }

  // enemies
  for(const e of snap.enemies){
    const f=Math.floor(performance.now()/200)%2;
    drawSheet(SPR.enemy, f, e.x, e.y, 54, e.vx<0);
    ctx.fillStyle="rgba(0,0,0,.35)";
    ctx.fillRect(e.x-22,e.y-40,44,6);
    ctx.fillStyle="#ef4444";
    ctx.fillRect(e.x-22,e.y-40,44*(e.hp/80),6);
  }

  // players
  for(const [id,p] of Object.entries(snap.players)){
    const walking = Math.hypot(p.ix||0,p.iy||0)>0.1;
    const dead = !p.alive;
    const recentShoot = (id===myId && firing) || (performance.now()-lastShot<120 && id===myId);

    let frame=0;
    if(dead) frame=4;
    else if(recentShoot) frame=3;
    else if(walking) frame=(Math.floor(performance.now()/140)%2)+1;

    const sheet = (p.cls==="tank") ? SPR.tank : SPR.soldier;
    const flip = (p.aimX||1) < 0;
    drawSheet(sheet, frame, p.x, p.y, 58, flip);

    // ONLY direction pointer for local player (no circle)
    if(id===myId){
      const ax=(p.aimX||1), ay=(p.aimY||0);
      const al=Math.hypot(ax,ay)||1;
      const ux=ax/al, uy=ay/al;
      ctx.strokeStyle="rgba(255,255,255,.85)";
      ctx.lineWidth=5;
      ctx.lineCap="round";
      ctx.beginPath();
      ctx.moveTo(p.x + ux*18, p.y + uy*18);
      ctx.lineTo(p.x + ux*42, p.y + uy*42);
      ctx.stroke();
    }

    // hp bar
    ctx.fillStyle="rgba(0,0,0,.35)";
    ctx.fillRect(p.x-24,p.y-46,48,6);
    ctx.fillStyle="#22c55e";
    ctx.fillRect(p.x-24,p.y-46,48*(p.hp/p.max),6);
  }

  ctx.restore();
}

function loop(t){
  netTick(t);
  if(!endDiv.style.display || endDiv.style.display==="none") draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
  </html>
