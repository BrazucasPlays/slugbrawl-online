<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{margin:0;background:#000;color:#fff;font-family:Arial}
canvas{display:block}
#menu, #endMenu{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.7);z-index: 100; opacity: 1; transition: opacity 0.5s;}
#box{background:#111;padding:16px;border-radius:12px;width:280px; text-align: center;}
input,button{width:100%;margin-top:10px;padding:12px;border-radius:8px;border:none}
button{background:#ffc;color:#000;font-weight:bold}
#hud{position:fixed;top:10px;left:10px;font-weight:bold; color: #fff; text-shadow: 1px 1px 2px #000;}
#soundToggle{position:fixed;top:10px;right:10px;padding:10px;background:#333;color:#fff;border-radius:8px;cursor:pointer}

/* Estilos de Sele√ß√£o de Jogador */
#playerSelect{margin: 15px 0 10px 0; display: flex; justify-content: space-around;}
.colorOption{width: 25px; height: 25px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; transition: border-color 0.1s;}
.colorOption.selected{border-color: #ffc;}

#joy{position:fixed;left:20px;bottom:20px;width:140px;height:140px;border-radius:50%;background:#333}
#knob{position:absolute;left:50%;top:50%;width:60px;height:60px;margin:-30px;border-radius:50%;background:#fff}
#fire{position:fixed;right:20px;bottom:60px;padding:18px;background:#ffc;color:#000;border-radius:12px;font-weight:bold}

#endBox{background:#111;padding:25px;border-radius:12px;width:350px; text-align: center;}
#endTitle{font-size: 2em; margin-bottom: 10px;}
#endStats{margin-bottom: 20px;}
</style>
</head>
<body>

<div id="menu">
  <div id="box">
    <h3>SlugBrawl</h3>
    <input id="name" placeholder="Nome">
    <div id="playerSelect">
        <div class="colorOption selected" style="background-color: #22c55e;" data-color="#22c55e" onclick="selectColor(this)"></div>
        <div class="colorOption" style="background-color: #3b82f6;" data-color="#3b82f6" onclick="selectColor(this)"></div>
        <div class="colorOption" style="background-color: #a855f7;" data-color="#a855f7" onclick="selectColor(this)"></div>
        <div class="colorOption" style="background-color: #f97316;" data-color="#f97316" onclick="selectColor(this)"></div>
        <div class="colorOption" style="background-color: #06b6d4;" data-color="#06b6d4" onclick="selectColor(this)"></div>
    </div>
    <input id="room" placeholder="Sala (ou vazio solo)">
    <button onclick="join()">JOGAR</button>
  </div>
</div>

<div id="endMenu" style="display:none; opacity: 0;">
    <div id="endBox">
        <h3 id="endTitle">FIM DE JOGO</h3>
        <div id="endStats"></div>
        <button onclick="restartGame()">REINICIAR</button>
        <p style="font-size: 0.8em; margin-top: 15px;">(O mapa ser√° resetado)</p>
    </div>
</div>

<div id="hud"></div>
<div id="soundToggle" onclick="Audio.toggleMute()">üîä Som ON</div>
<canvas id="c"></canvas>
<div id="joy"><div id="knob"></div></div>
<div id="fire">ATIRAR</div>

<script>
const c=document.getElementById("c"),ctx=c.getContext("2d");
c.width=innerWidth;c.height=innerHeight;
const MAP_WIDTH = 1800; 
const MAP_HEIGHT = 1000;
let lastPlayerHp = 100;
let isGameOver = false;
let playerColor = "#22c55e"; 


// --- FUN√á√ÉO DE SELE√á√ÉO DE COR NO MENU ---
function selectColor(element) {
    document.querySelectorAll('.colorOption').forEach(el => el.classList.remove('selected'));
    element.classList.add('selected');
    playerColor = element.dataset.color;
}

// --- FUN√á√ïES DE √ÅUDIO SINT√âTICO ---
function generateSynthAudio(freq, duration, type='sine', decay=0.5) {
    const sampleRate = 44100;
    const numSamples = sampleRate * duration;
    const buffer = Audio.context.createBuffer(1, numSamples, sampleRate);
    const data = buffer.getChannelData(0);

    for (let i = 0; i < numSamples; i++) {
        const time = i / sampleRate;
        const volume = Math.exp(-time / decay);
        let sample;
        if (type === 'sine') { sample = Math.sin(2 * Math.PI * freq * time); } 
        else if (type === 'square') { sample = Math.sign(Math.sin(2 * Math.PI * freq * time)); } 
        else { sample = Math.random() * 2 - 1; }
        data[i] = sample * volume;
    }
    return buffer;
}

const Assets = { audioBuffers: {}, loadAll(callback) {
    this.audioBuffers.shoot_sound = generateSynthAudio(800, 0.08, 'square', 0.05);
    this.audioBuffers.damage_sound = generateSynthAudio(150, 0.2, 'sine', 0.1);
    this.audioBuffers.heal_sound = generateSynthAudio(1200, 0.15, 'sine', 0.08);
    this.audioBuffers.death_sound = generateSynthAudio(60, 0.5, 'square', 0.2);
    this.audioBuffers.victory_sound = generateSynthAudio(1500, 0.3, 'sine', 0.2);
    callback();
}};

const Audio = {
    context: new (window.AudioContext || window.webkitAudioContext)(),
    masterGain: null,
    isMuted: false,
    init() {
        this.masterGain = this.context.createGain();
        this.masterGain.connect(this.context.destination);
    },
    playSound(key, volume = 1.0) {
        if (this.isMuted || !Assets.audioBuffers[key]) return;
        const buffer = Assets.audioBuffers[key];
        const source = this.context.createBufferSource();
        source.buffer = buffer;
        const gainNode = this.context.createGain();
        gainNode.gain.value = volume;
        source.connect(gainNode);
        gainNode.connect(this.masterGain);
        source.start(0);
    },
    toggleMute() {
        this.isMuted = !this.isMuted;
        this.masterGain.gain.value = this.isMuted ? 0 : 1;
        document.getElementById('soundToggle').textContent = this.isMuted ? 'üîá Som OFF' : 'üîä Som ON';
    }
};
Audio.init();

// --- L√ìGICA DE WEBSOCKET E JOGO ---
const ws=new WebSocket((location.protocol==="https:"?"wss://":"ws://")+location.hostname);
let myId,state,roomKey="solo",aim={x:1,y:0},move={x:0,y:0};

function join(){
  Audio.context.resume(); 
  roomKey=document.getElementById("room").value||"solo";
  ws.send(JSON.stringify({
    t:"join",
    name:document.getElementById("name").value,
    room:roomKey,
    color: playerColor 
  }));
  document.getElementById("menu").style.display="none"; 
  isGameOver = false;
  document.getElementById("endMenu").style.display="none"; 
  document.getElementById("joy").style.display="block";
  document.getElementById("fire").style.display="block";
}

function restartGame(){
    ws.send(JSON.stringify({t:"reset"})); 
    myId = null; 
    // Garante que o servidor tenha tempo de deletar a sala antes de tentar entrar
    setTimeout(join, 100); 
}

function showEndMenu(status, kills){
    isGameOver = true;
    document.getElementById("joy").style.display="none";
    document.getElementById("fire").style.display="none";
    
    const title = document.getElementById("endTitle");
    const stats = document.getElementById("endStats");
    let message = "";
    
    if (status === 'victory') {
        title.textContent = "üèÜ VIT√ìRIA!";
        title.style.color = "#22c55e";
        Audio.playSound('victory_sound', 1.0);
        message = `Parab√©ns! Voc√™ escapou da fase.<br>Voc√™ eliminou **${kills}** inimigos.`;
    } else {
        title.textContent = "üíÄ FIM DE JOGO";
        title.style.color = "#f00";
        Audio.playSound('death_sound', 1.0);
        message = `Voc√™ foi eliminado. Sua pontua√ß√£o foi:<br>Mortes: **${kills}**`;
    }
    
    stats.innerHTML = `<p style="font-size: 1.2em;">${message}</p>`;

    document.getElementById("endMenu").style.display="flex";
    setTimeout(() => {
        document.getElementById("endMenu").style.opacity = 1;
    }, 10); 
}


ws.onmessage=e=>{
  const m=JSON.parse(e.data);
  if(m.t==="you"){
    myId=m.id;
    lastPlayerHp = m.lastHp;
  }
  if(m.t==="state"){
    state=m.rooms[roomKey];
    if(!state) return;

    if(myId && state.players[myId]) {
      const me = state.players[myId];
      
      if(me.status && !isGameOver){
          showEndMenu(me.status, me.kills);
      }
      
      if(me.hp < lastPlayerHp && me.hp > 0) { Audio.playSound('damage_sound', 0.8); } 
      else if (me.hp > lastPlayerHp) { Audio.playSound('heal_sound', 0.7); }
      lastPlayerHp = me.hp;
    }
  }
};

// --- CONTROLES (Joystick Corrigido) ---
const joy=document.getElementById("joy");
const knob=document.getElementById("knob");
let center={x:0,y:0},drag=false,MAX=50;

joy.onpointerdown=e=>{
  if(isGameOver) return;
  Audio.context.resume(); 
  const r=joy.getBoundingClientRect();
  center.x=r.left+r.width/2;
  center.y=r.top+r.height/2;
  drag=true;
};

joy.onpointermove=e=>{
  if(!drag || isGameOver) return;
  
  const dx=e.clientX-center.x,dy=e.clientY-center.y;
  const d=Math.hypot(dx,dy);
  const m=Math.min(d,MAX);
  
  const nx=(dx/d||0)*m,ny=(dy/d||0)*m;
  knob.style.transform=`translate(${nx}px,${ny}px)`;
  
  // L√≥gica de Movimento Normalizada (Corrigida)
  if (d <= MAX) {
      move.x = dx / MAX;
      move.y = dy / MAX;
  } 
  else {
      move.x = dx / d;
      move.y = dy / d;
  }
  
  const L=Math.hypot(move.x,move.y)||1;
  aim.x=move.x/L; aim.y=move.y/L;
  
  ws.send(JSON.stringify({t:"move",x:move.x,y:move.y}));
};

joy.onpointerup=()=>{
  if(isGameOver) return;
  drag=false; knob.style.transform="";
  move.x=move.y=0;
  ws.send(JSON.stringify({t:"move",x:0,y:0}));
};

document.getElementById("fire").onclick=()=>{
  if(isGameOver) return;
  Audio.playSound('shoot_sound', 0.5); 
  ws.send(JSON.stringify({t:"shoot",ax:aim.x,ay:aim.y}));
};


// --- M√ìDULO DE RENDERIZA√á√ÉO (Desenho de C√çRCULOS) ---
const Renderer = {
    draw(timestamp) {
        ctx.clearRect(0,0,c.width,c.height);
        if(!state||!myId||!state.players[myId]){requestAnimationFrame(Renderer.draw);return;}

        const me=state.players[myId];
        ctx.save();
        ctx.translate(c.width/2-me.x,c.height/2-me.y);
        
        ctx.fillStyle = '#4f6c4c'; 
        ctx.fillRect(0, 0, MAP_WIDTH, MAP_HEIGHT); 

        Renderer.drawDoor(state.door);
        Renderer.drawLifes(state.lifes);
        Renderer.drawBullets(state.bullets);
        Renderer.drawEnemies(state.enemies);
        Renderer.drawPlayers(state.players, myId); 
        Renderer.drawZone(state.zone);

        ctx.restore(); 
        
        const zonePercent = Math.min(100, Math.floor((state.zone / (MAP_WIDTH / 2)) * 100));
        const zoneMessage = zonePercent < 15 ? "FASE ABERTA" : `ZONA FECHANDO: ${zonePercent}%`;

        document.getElementById("hud").innerHTML=
            `HP: **${Math.floor(me.hp)}** | Kills: **${me.kills}**<br>${zoneMessage}`;

        requestAnimationFrame(Renderer.draw);
    },

    drawPlayers(players, myId) {
        for(const p of Object.values(players)){
            // Verifica se o jogador est√° vivo ou se acabou de ganhar (para desenhar na porta)
            if(p.hp <= 0 && p.status !== 'victory') continue; 

            ctx.globalAlpha = p.alive ? 1.0 : 0.5; 
            // Usa a cor do jogador se for o local, ou o padr√£o se for um inimigo (ou outro player)
            ctx.fillStyle = p.id === myId ? playerColor : "#f00"; 
            
            ctx.beginPath();ctx.arc(p.x,p.y,16,0,Math.PI*2);ctx.fill();
            ctx.globalAlpha = 1.0;

            if(p.hp > 0 || p.id === myId){
                ctx.fillStyle="rgba(0,0,0,.5)";
                ctx.fillRect(p.x-22,p.y-28,44,6);
                ctx.fillStyle="#22c55e";
                ctx.fillRect(p.x-22,p.y-28,44*(p.hp/p.max),6);
            }

            ctx.textAlign = 'center';
            ctx.fillStyle = p.id===myId?"#ffc":"#fff";
            ctx.font = 'bold 12px Arial';
            ctx.fillText(p.name, p.x, p.y - 35);
        }
    },

    drawEnemies(enemies) {
        enemies.forEach(e => {
            ctx.fillStyle="#ff0";
            ctx.beginPath();ctx.arc(e.x,e.y,14,0,Math.PI*2);ctx.fill();
            ctx.fillStyle="rgba(0,0,0,.5)";
            ctx.fillRect(e.x-15,e.y-22,30,4);
            ctx.fillStyle="#f00";
            ctx.fillRect(e.x-15,e.y-22,30*(e.hp/60),4); 
        });
    },

    drawDoor(door) {
        ctx.fillStyle=door.open?"#00f":"#888";
        ctx.fillRect(door.x-20,door.y-30,40,60);
        if(door.open){
             ctx.fillStyle="#ffc";
             ctx.textAlign = 'center';
             ctx.fillText("SA√çDA", door.x, door.y + 10);
        }
    },

    drawLifes(lifes) {
        lifes.forEach(l => {
            ctx.fillStyle="#fff";
            ctx.beginPath();ctx.arc(l.x,l.y,12,0,Math.PI*2);ctx.fill();
            ctx.fillStyle="#f00";
            ctx.fillRect(l.x-2, l.y-8, 4, 16);
            ctx.fillRect(l.x-8, l.y-2, 16, 4);
        });
    },

    drawBullets(bullets) {
        bullets.forEach(b=>{
            ctx.fillStyle=b.from==="e"?"#ff4d6d":"#fff";
            ctx.fillRect(b.x-2,b.y-2,4,4);
        });
    },

    drawZone(zone) {
        ctx.fillStyle = 'rgba(255, 0, 0, 0.15)'; 
        ctx.fillRect(0, 0, MAP_WIDTH, zone); 
        ctx.fillRect(0, MAP_HEIGHT - zone, MAP_WIDTH, zone); 
        ctx.fillRect(0, zone, zone, MAP_HEIGHT - 2 * zone);
        ctx.fillRect(MAP_WIDTH - zone, zone, zone, MAP_HEIGHT - 2 * zone);
    }
};

// --- PONTO DE ENTRADA FINAL ---
Assets.loadAll(() => {
    requestAnimationFrame(Renderer.draw);
});
</script>
</body>
</html>
