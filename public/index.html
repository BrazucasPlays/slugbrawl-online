<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<style>
body{margin:0;background:#000;color:#fff;font-family:Arial;overflow:hidden}
canvas{display:block}
#menu{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.7);z-index:10}
#box{background:#111;padding:16px;border-radius:12px;width:280px}
input,button{width:100%;margin-top:10px;padding:12px;border-radius:8px;border:none}
button{background:#ffc;color:#000;font-weight:bold}
#hud{position:fixed;top:10px;left:10px;font-weight:bold;z-index:5}

#joy{
  position:fixed;left:20px;bottom:20px;
  width:140px;height:140px;border-radius:50%;
  background:rgba(255,255,255,.15);
  border:2px solid rgba(255,255,255,.25);
  z-index:20;touch-action:none;
}
#knob{
  position:absolute;left:50%;top:50%;
  width:60px;height:60px;margin:-30px;
  border-radius:50%;background:#fff;
}
#fire{
  position:fixed;right:20px;bottom:60px;
  padding:18px 24px;background:#ffc;
  color:#000;border-radius:12px;
  font-weight:bold;z-index:20;
}
</style>
</head>
<body>

<div id="menu">
  <div id="box">
    <h3>SlugBrawl</h3>
    <input id="name" placeholder="Nome">
    <input id="room" placeholder="Sala (ou vazio solo)">
    <button onclick="join()">JOGAR</button>
  </div>
</div>

<div id="hud">Conectandoâ€¦</div>
<canvas id="c"></canvas>

<div id="joy"><div id="knob"></div></div>
<div id="fire">ATIRAR</div>

<script>
/* ===== Canvas ===== */
const c=document.getElementById("c"),ctx=c.getContext("2d");
function resize(){c.width=innerWidth;c.height=innerHeight}
addEventListener("resize",resize);resize();

/* ===== WebSocket ===== */
const ws=new WebSocket((location.protocol==="https:"?"wss://":"ws://")+location.hostname);
let myId,state,aim={x:1,y:0},move={x:0,y:0},roomKey="solo";

function join(){
  roomKey=document.getElementById("room").value||"solo";
  ws.send(JSON.stringify({
    t:"join",
    name:document.getElementById("name").value||"Player",
    room:roomKey
  }));
  document.getElementById("menu").style.display="none";
}

ws.onmessage=e=>{
  const m=JSON.parse(e.data);
  if(m.t==="you"){myId=m.id;document.getElementById("hud").textContent="Jogando";}
  if(m.t==="state"){state=m.rooms[roomKey];}
};

/* ===== JOYSTICK REAL ===== */
const joy=document.getElementById("joy");
const knob=document.getElementById("knob");
let center={x:0,y:0},drag=false;
const MAX=50;

joy.addEventListener("pointerdown",e=>{
  const r=joy.getBoundingClientRect();
  center.x=r.left+r.width/2;
  center.y=r.top+r.height/2;
  drag=true;
  joy.setPointerCapture(e.pointerId);
});

joy.addEventListener("pointermove",e=>{
  if(!drag) return;
  const dx=e.clientX-center.x;
  const dy=e.clientY-center.y;
  const d=Math.hypot(dx,dy);
  const m=Math.min(d,MAX);
  const nx=(dx/d||0)*m;
  const ny=(dy/d||0)*m;

  knob.style.transform=`translate(${nx}px,${ny}px)`;
  move.x=nx/MAX;
  move.y=ny/MAX;

  const l=Math.hypot(move.x,move.y)||1;
  aim.x=move.x/l;
  aim.y=move.y/l;

  ws.send(JSON.stringify({t:"move",x:move.x,y:move.y}));
});

joy.addEventListener("pointerup",()=>{
  drag=false;
  knob.style.transform="";
  move.x=0;move.y=0;
  ws.send(JSON.stringify({t:"move",x:0,y:0}));
});

/* ===== ATIRAR ===== */
document.getElementById("fire").addEventListener("pointerdown",()=>{
  ws.send(JSON.stringify({t:"shoot",ax:aim.x,ay:aim.y}));
});

/* ===== DRAW ===== */
function loop(){
  ctx.clearRect(0,0,c.width,c.height);
  if(!state||!myId){requestAnimationFrame(loop);return;}

  const me=state.players[myId];
  ctx.save();
  ctx.translate(c.width/2-me.x,c.height/2-me.y);

  for(const p of Object.values(state.players)){
    ctx.fillStyle=p.id===myId?"#0f0":"#f00";
    ctx.beginPath();ctx.arc(p.x,p.y,16,0,Math.PI*2);ctx.fill();
  }

  state.enemies.forEach(e=>{
    ctx.fillStyle="#ff0";
    ctx.beginPath();ctx.arc(e.x,e.y,14,0,Math.PI*2);ctx.fill();
  });

  state.bullets.forEach(b=>{
    ctx.fillStyle="#fff";
    ctx.fillRect(b.x-2,b.y-2,4,4);
  });

  ctx.fillStyle=state.door.open?"#0f0":"#f00";
  ctx.fillRect(state.door.x-20,state.door.y-30,40,60);

  ctx.restore();

  document.getElementById("hud").textContent=
    `HP: ${Math.floor(me.hp)} | Kills: ${me.kills}`;

  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
